<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enfantTerrible.enfantTerrible.mapper.user.UserMapper">
  <select id="findByEmail" resultType="UserRow">
    SELECT * FROM et_user
    WHERE email = #{email}
      AND status = 'ACTIVE'
      AND deleted_at IS NULL
  </select>

  <select id="findById" resultType="UserRow">
    SELECT * FROM et_user
    WHERE user_id = #{userId}
      AND deleted_at IS NULL
  </select>

  <insert id="insert" useGeneratedKeys="true" keyProperty="userId">
    INSERT INTO et_user (
      email, password, name, tel, zip_code, address_base, address_detail,
      email_verified, role, provider, status
    ) VALUES (
      #{email}, #{password}, #{name}, #{tel}, #{zipCode}, #{addressBase}, #{addressDetail},
      #{emailVerified}, #{role}, #{provider}, #{status}
    )
  </insert>

  <select id="countByEmail" resultType="int">
    SELECT COUNT(*)
    FROM et_user
    WHERE email = #{email}
      AND deleted_at IS NULL
  </select>

  <update id="verifyEmail">
    UPDATE et_user
    SET
      email_verified = "Y"
    WHERE user_id = #{userId}
      AND deleted_at IS NULL
  </update>

  <update id="updateProfile">
    UPDATE et_user
    SET
      name = #{name},
      tel = #{tel},
      zip_code = #{zipCode},
      address_base = #{addressBase},
      address_detail = #{addressDetail}
    WHERE user_id = #{userId}
      AND deleted_at IS NULL
  </update>

  <update id="updatePassword">
    UPDATE et_user
    SET
      password = #{password},
      password_updated_at = NOW()
    WHERE user_id = #{userId}
      AND deleted_at IS NULL
  </update>

  <update id="updateLastLogin">
    UPDATE et_user
    SET last_login_at = NOW()
    WHERE user_id = #{userId}
  </update>

  <update id="softDelete">
    UPDATE et_user
    SET
      deleted_at = NOW(),
      status = 'DELETED'
    WHERE user_id = #{userId}
      AND deleted_at IS NULL
  </update>

  <select id="findSocialAccount"
          resultType="map">
    SELECT
      sa.social_id AS social_account_id,
      sa.user_id,
      sa.provider,
      sa.provider_user_id
    FROM et_social_account sa
    WHERE sa.provider = #{provider}
      AND sa.provider_user_id = #{providerUserId}
  </select>

  <insert id="insertSocialAccount">
    INSERT INTO et_social_account (
      user_id,
      provider,
      provider_user_id
    ) VALUES (
      #{userId},
      #{provider},
      #{providerUserId}
    )
  </insert>

  <insert id="insertOAuthUser" useGeneratedKeys="true" keyProperty="userId">
    INSERT INTO et_user (
      email,
      password,
      name,
      role,
      provider,
      status,
      email_verified
    ) VALUES (
      #{email},
      #{password},
      #{name},
      #{role},
      #{provider},
      #{status},
      #{emailVerified}
    )
  </insert>

  <select id="findByUserId" resultType="UserRow">
    SELECT *
    FROM et_user
    WHERE user_id = #{userId}
      AND deleted_at IS NULL
  </select>

</mapper>