<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enfantTerrible.enfantTerrible.mapper.admin.payment.AdminPaymentMapper">

  <sql id="adminPaymentWhere">
    WHERE 1=1

    <if test="req.userId != null">
      AND o.user_id = #{req.userId}
    </if>

    <if test="req.orderId != null">
      AND p.order_id = #{req.orderId}
    </if>

    <if test="req.orderCode != null and req.orderCode != ''">
      AND o.order_code LIKE CONCAT('%', #{req.orderCode}, '%')
    </if>

    <if test="req.paymentStatus != null and req.paymentStatus != ''">
      AND p.payment_status = #{req.paymentStatus}
    </if>

    <if test="req.minPaymentAmount != null">
      AND p.payment_amount &gt;= #{req.minPaymentAmount}
    </if>

    <if test="req.maxPaymentAmount != null">
      AND p.payment_amount &lt;= #{req.maxPaymentAmount}
    </if>

    <if test="req.paidFrom != null">
      AND p.paid_at &gt;= #{req.paidFrom}
    </if>

    <if test="req.paidTo != null">
      AND p.paid_at &lt;= #{req.paidTo}
    </if>
  </sql>

  <select id="findPayments" resultType="com.enfantTerrible.enfantTerrible.dto.admin.payment.AdminPaymentListResponse">
    SELECT
      p.payment_id,
      p.order_id,
      o.user_id,
      o.order_code,
      p.payment_method,
      p.payment_amount,
      p.payment_status,
      p.pg_tid,
      p.paid_at,
      p.created_at
    FROM et_payment p
    JOIN et_order o ON o.order_id = p.order_id
    <include refid="adminPaymentWhere" />
    ORDER BY
    <choose>
      <when test="req.sortBy == 'PAYMENT_AMOUNT'">p.payment_amount</when>
      <when test="req.sortBy == 'PAID_AT'">p.paid_at</when>
      <when test="req.sortBy == 'CREATED_AT'">p.created_at</when>
      <otherwise>p.payment_id</otherwise>
    </choose>
    <choose>
      <when test="req.direction == 'ASC'">ASC</when>
      <otherwise>DESC</otherwise>
    </choose>
    LIMIT #{req.size} OFFSET #{req.offset}
  </select>

  <select id="countPayments" resultType="int">
    SELECT COUNT(*)
    FROM et_payment p
    JOIN et_order o ON o.order_id = p.order_id
    <include refid="adminPaymentWhere" />
  </select>

  <select id="findPaymentDetail" resultType="com.enfantTerrible.enfantTerrible.dto.admin.payment.AdminPaymentDetailResponse">
    SELECT
      p.payment_id,
      p.order_id,
      o.user_id,
      o.order_code,
      p.payment_method,
      p.payment_amount,
      p.payment_status,
      p.pg_tid,
      p.paid_at,
      p.created_at,
      p.updated_at
    FROM et_payment p
    JOIN et_order o ON o.order_id = p.order_id
    WHERE p.payment_id = #{paymentId}
  </select>

</mapper>
