<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enfantTerrible.enfantTerrible.mapper.admin.banner.AdminBannerMapper">

  <sql id="adminBannerWhere">
    WHERE b.deleted_at IS NULL

    <if test="req.title != null and req.title != ''">
      AND b.title LIKE CONCAT('%', #{req.title}, '%')
    </if>

    <if test="req.isActive != null">
      AND b.is_active = #{req.isActive}
    </if>
  </sql>

  <select id="findBanners" resultType="com.enfantTerrible.enfantTerrible.dto.admin.banner.AdminBannerListResponse">
    SELECT
      b.banner_id,
      b.title,
      b.link_url,
      b.sort_order,
      b.is_active,
      b.start_at,
      b.end_at,
      b.created_at
    FROM et_banner b
    <include refid="adminBannerWhere" />
    ORDER BY
    <choose>
      <when test="req.sortBy == 'BANNER_ID'">b.banner_id</when>
      <when test="req.sortBy == 'CREATED_AT'">b.created_at</when>
      <otherwise>b.sort_order</otherwise>
    </choose>
    <choose>
      <when test="req.direction == 'DESC'">DESC</when>
      <otherwise>ASC</otherwise>
    </choose>
    , b.banner_id DESC
    LIMIT #{req.size} OFFSET #{req.offset}
  </select>

  <select id="countBanners" resultType="int">
    SELECT COUNT(*)
    FROM et_banner b
    <include refid="adminBannerWhere" />
  </select>

  <select id="findById" resultType="com.enfantTerrible.enfantTerrible.dto.admin.banner.AdminBannerDetailResponse">
    SELECT
      b.banner_id,
      b.title,
      b.link_url,
      b.sort_order,
      b.is_active,
      b.start_at,
      b.end_at,
      b.created_at,
      b.updated_at,
      b.deleted_at
    FROM et_banner b
    WHERE b.banner_id = #{bannerId}
  </select>

  <insert id="insert">
    INSERT INTO et_banner (
      title,
      link_url,
      sort_order,
      is_active,
      start_at,
      end_at
    ) VALUES (
      #{title},
      #{linkUrl},
      COALESCE(#{sortOrder}, 0),
      COALESCE(#{isActive}, 1),
      #{startAt},
      #{endAt}
    )
  </insert>

  <select id="findLastInsertId" resultType="long">
    SELECT LAST_INSERT_ID()
  </select>

  <update id="update">
    UPDATE et_banner
    SET
      title = #{title},
      link_url = #{linkUrl},
      sort_order = COALESCE(#{sortOrder}, 0),
      is_active = COALESCE(#{isActive}, 1),
      start_at = #{startAt},
      end_at = #{endAt}
    WHERE banner_id = #{bannerId}
      AND deleted_at IS NULL
  </update>

  <update id="softDelete">
    UPDATE et_banner
    SET deleted_at = NOW()
    WHERE banner_id = #{bannerId}
      AND deleted_at IS NULL
  </update>

</mapper>
