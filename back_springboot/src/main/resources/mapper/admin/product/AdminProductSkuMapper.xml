<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enfantTerrible.enfantTerrible.mapper.admin.product.AdminProductSkuMapper">

  <sql id="selectColumns">
    s.sku_id,
    s.product_id,
    s.sku_code,
    s.price,
    s.stock,
    s.status,
    s.created_at
  </sql>

  <sql id="where">
    WHERE s.deleted_at IS NULL

    <if test="req.productId != null">
      AND s.product_id = #{req.productId}
    </if>

    <if test="req.status != null and req.status != ''">
      AND s.status = #{req.status}
    </if>

    <if test="req.minPrice != null">
      AND s.price &gt;= #{req.minPrice}
    </if>

    <if test="req.maxPrice != null">
      AND s.price &lt;= #{req.maxPrice}
    </if>

    <if test="req.minStock != null">
      AND s.stock &gt;= #{req.minStock}
    </if>

    <if test="req.maxStock != null">
      AND s.stock &lt;= #{req.maxStock}
    </if>
  </sql>

  <select id="findSkus" resultType="AdminSkuRow">
    SELECT <include refid="selectColumns" />
    FROM et_product_sku s
    <include refid="where" />
    ORDER BY
    <choose>
      <when test="req.sortBy == 'CREATED_AT'">s.created_at</when>
      <when test="req.sortBy == 'PRICE'">s.price</when>
      <when test="req.sortBy == 'STOCK'">s.stock</when>
      <otherwise>s.sku_id</otherwise>
    </choose>
    <choose>
      <when test="req.direction == 'ASC'">ASC</when>
      <otherwise>DESC</otherwise>
    </choose>
    LIMIT #{size} OFFSET #{offset}
  </select>

  <select id="countSkus" resultType="int">
    SELECT COUNT(*)
    FROM et_product_sku s
    <include refid="where" />
  </select>

  <select id="findById" resultType="AdminSkuRow">
    SELECT <include refid="selectColumns" />
    FROM et_product_sku s
    WHERE s.sku_id = #{skuId}
      AND s.deleted_at IS NULL
  </select>

  <select id="findSkuIdsByProductId" resultType="long">
    SELECT s.sku_id
    FROM et_product_sku s
    WHERE s.product_id = #{productId}
      AND s.deleted_at IS NULL
    ORDER BY s.sku_id ASC
  </select>

  <!-- ⭐ generatedKeys로 skuId 받기 -->
  <insert id="insertInternal" useGeneratedKeys="true" keyProperty="skuId">
    INSERT INTO et_product_sku (
      product_id,
      sku_code,
      price,
      stock,
      status
    ) VALUES (
      #{productId},
      #{skuCode},
      #{price},
      #{stock},
      #{status}
    )
  </insert>

  <update id="update">
    UPDATE et_product_sku
    SET
      price = #{req.price},
      stock = #{req.stock},
      status = #{req.status}
    WHERE sku_id = #{skuId}
      AND deleted_at IS NULL
  </update>

  <update id="softDelete">
    UPDATE et_product_sku
    SET deleted_at = NOW()
    WHERE sku_id = #{skuId}
      AND deleted_at IS NULL
  </update>

  <!-- ⭐ 1안: product.base_price = MIN(active sku price) -->
  <update id="refreshProductBasePrice">
    UPDATE et_product p
    SET p.base_price = (
      SELECT COALESCE(MIN(s.price), 0)
      FROM et_product_sku s
      WHERE s.product_id = p.product_id
        AND s.deleted_at IS NULL
    )
    WHERE p.product_id = #{productId}
      AND p.deleted_at IS NULL
  </update>

</mapper>
