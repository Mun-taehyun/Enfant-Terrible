<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.enfantTerrible.enfantTerrible.mapper.admin.product.AdminProductMapper">

  <sql id="selectColumns">
    p.product_id,
    p.product_code,
    p.name,
    p.base_price,
    p.status,
    p.category_id,
    c.name AS category_name,
    p.created_at
  </sql>

  <sql id="where">
    WHERE p.deleted_at IS NULL

    <if test="req.status != null and req.status != ''">
      AND p.status = #{req.status}
    </if>

    <if test="req.keyword != null and req.keyword != ''">
      AND p.name LIKE CONCAT('%', #{req.keyword}, '%')
    </if>

    <if test="req.productCode != null and req.productCode != ''">
      AND p.product_code LIKE CONCAT('%', #{req.productCode}, '%')
    </if>
  </sql>

  <select id="findProducts" resultType="AdminProductRow">
    SELECT <include refid="selectColumns" />
    FROM et_product p
    JOIN et_category c ON c.category_id = p.category_id
    <include refid="where" />
    ORDER BY p.product_id DESC
    LIMIT #{size} OFFSET #{offset}
  </select>

  <select id="countProducts" resultType="int">
    SELECT COUNT(*)
    FROM et_product p
    <include refid="where" />
  </select>

  <select id="findById" resultType="AdminProductRow">
    SELECT <include refid="selectColumns" />
    FROM et_product p
    JOIN et_category c ON c.category_id = p.category_id
    WHERE p.product_id = #{productId}
      AND p.deleted_at IS NULL
  </select>

  <insert id="insert">
    INSERT INTO et_product (
      product_code,
      category_id,
      name,
      base_price,
      status
    ) VALUES (
      #{productCode},
      #{categoryId},
      #{name},
      #{basePrice},
      #{status}
    )
  </insert>

  <update id="update">
    UPDATE et_product
    SET
      product_code = #{req.productCode},
      category_id = #{req.categoryId},
      name = #{req.name},
      base_price = #{req.basePrice},
      status = #{req.status}
    WHERE product_id = #{productId}
      AND deleted_at IS NULL
  </update>

  <update id="softDelete">
    UPDATE et_product
    SET deleted_at = NOW()
    WHERE product_id = #{productId}
      AND deleted_at IS NULL
  </update>

</mapper>
