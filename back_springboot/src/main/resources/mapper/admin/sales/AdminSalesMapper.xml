<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enfantTerrible.enfantTerrible.mapper.admin.sales.AdminSalesMapper">

  <sql id="salesWhere">
    WHERE 1=1
      AND p.payment_status = 'SUCCESS'

    <if test="req.paidFrom != null">
      AND p.paid_at &gt;= #{req.paidFrom}
    </if>

    <if test="req.paidTo != null">
      AND p.paid_at &lt;= #{req.paidTo}
    </if>
  </sql>

  <select id="findSalesByPeriod" resultType="com.enfantTerrible.enfantTerrible.dto.admin.sales.AdminSalesSummaryRow">
    SELECT
      <choose>
        <when test="req.groupBy == 'MONTH'">
          DATE_FORMAT(p.paid_at, '%Y-%m') AS period
        </when>
        <otherwise>
          DATE_FORMAT(p.paid_at, '%Y-%m-%d') AS period
        </otherwise>
      </choose>,
      COALESCE(SUM(p.payment_amount), 0) AS total_amount,
      COUNT(*) AS payment_count
    FROM et_payment p
    <include refid="salesWhere" />
    GROUP BY period
    ORDER BY period ASC
  </select>

  <select id="findSalesTotal" resultType="com.enfantTerrible.enfantTerrible.dto.admin.sales.AdminSalesSummaryRow">
    SELECT
      'TOTAL' AS period,
      COALESCE(SUM(p.payment_amount), 0) AS total_amount,
      COUNT(*) AS payment_count
    FROM et_payment p
    <include refid="salesWhere" />
  </select>

</mapper>
