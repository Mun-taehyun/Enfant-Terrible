<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enfantTerrible.enfantTerrible.mapper.product.ProductDiscountMapper">

  <sql id="activeWhere">
    (d.start_at IS NULL OR d.start_at &lt;= NOW())
    AND (d.end_at IS NULL OR d.end_at &gt;= NOW())
  </sql>

  <select id="findActiveByProductId" resultType="com.enfantTerrible.enfantTerrible.dto.product.ProductDiscountRow">
    SELECT
      d.discount_id,
      d.product_id,
      d.discount_value,
      d.discount_type,
      d.start_at,
      d.end_at,
      d.created_at
    FROM et_product_discount d
    WHERE d.product_id = #{productId}
      AND <include refid="activeWhere" />
    ORDER BY COALESCE(d.start_at, d.created_at) DESC, d.discount_id DESC
    LIMIT 1
  </select>

  <select id="findActiveByProductIds" resultType="com.enfantTerrible.enfantTerrible.dto.product.ProductDiscountRow">
    SELECT
      d.discount_id,
      d.product_id,
      d.discount_value,
      d.discount_type,
      d.start_at,
      d.end_at,
      d.created_at
    FROM et_product_discount d
    JOIN (
      SELECT
        product_id,
        MAX(discount_id) AS max_id
      FROM et_product_discount
      WHERE product_id IN
      <foreach item="id" collection="productIds" open="(" separator="," close=")">
        #{id}
      </foreach>
        AND (start_at IS NULL OR start_at &lt;= NOW())
        AND (end_at IS NULL OR end_at &gt;= NOW())
      GROUP BY product_id
    ) x ON x.max_id = d.discount_id
  </select>

  <select id="findByProductId" resultType="com.enfantTerrible.enfantTerrible.dto.product.ProductDiscountRow">
    SELECT
      d.discount_id,
      d.product_id,
      d.discount_value,
      d.discount_type,
      d.start_at,
      d.end_at,
      d.created_at
    FROM et_product_discount d
    WHERE d.product_id = #{productId}
    ORDER BY d.discount_id DESC
  </select>

  <select id="findById" resultType="com.enfantTerrible.enfantTerrible.dto.product.ProductDiscountRow">
    SELECT
      d.discount_id,
      d.product_id,
      d.discount_value,
      d.discount_type,
      d.start_at,
      d.end_at,
      d.created_at
    FROM et_product_discount d
    WHERE d.discount_id = #{discountId}
  </select>

  <insert id="insert">
    INSERT INTO et_product_discount (
      product_id,
      discount_value,
      discount_type,
      start_at,
      end_at
    ) VALUES (
      #{productId},
      #{discountValue},
      #{discountType},
      #{startAt},
      #{endAt}
    )
  </insert>

  <select id="findLastInsertId" resultType="long">
    SELECT LAST_INSERT_ID()
  </select>

  <update id="update">
    UPDATE et_product_discount
    SET
      discount_value = #{discountValue},
      discount_type = #{discountType},
      start_at = #{startAt},
      end_at = #{endAt}
    WHERE discount_id = #{discountId}
  </update>

  <delete id="delete">
    DELETE FROM et_product_discount
    WHERE discount_id = #{discountId}
  </delete>

</mapper>
