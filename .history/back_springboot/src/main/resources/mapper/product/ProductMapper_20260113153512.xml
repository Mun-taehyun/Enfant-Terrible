<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enfantTerrible.enfantTerrible.mapper.product.ProductMapper">

  <!-- ===========================
       공통 SELECT 컬럼
       - thumbnail_url은 et_file에서 가져온다 (alias: thumbnail_url)
       =========================== -->
  <sql id="productSelectColumns">
    p.product_id,
    p.category_id,
    c.name AS category_name,
    p.name,
    p.description,
    p.base_price,
    p.status,
  </sql>

  <!-- ===========================
       사용자 상품 공통 WHERE
       =========================== -->
  <sql id="userProductWhere">
    WHERE p.deleted_at IS NULL
      AND p.status IN ('ON_SALE', 'SOLD_OUT')

    <if test="categoryId != null">
      AND p.category_id = #{categoryId}
    </if>

    <if test="keyword != null and keyword != ''">
      AND p.name LIKE CONCAT('%', #{keyword}, '%')
    </if>
  </sql>

  <!-- ===========================
       사용자 상품 목록 조회
       =========================== -->
  <select id="findProducts" resultType="ProductRow">
    SELECT
      <include refid="productSelectColumns" />
    FROM et_product p
    JOIN et_category c ON c.category_id = p.category_id

    <include refid="userProductWhere" />

    ORDER BY
    <choose>
      <when test="orderBy == 'PRICE_ASC'">
        p.base_price ASC
      </when>
      <when test="orderBy == 'PRICE_DESC'">
        p.base_price DESC
      </when>
      <when test="orderBy == 'NAME'">
        p.name ASC
      </when>
      <otherwise>
        p.created_at DESC
      </otherwise>
    </choose>

    LIMIT #{size} OFFSET #{offset}
  </select>

  <!-- ===========================
       사용자 상품 상세 조회
       =========================== -->
  <select id="findById" resultType="ProductRow">
    SELECT
      <include refid="productSelectColumns" />
    FROM et_product p
    JOIN et_category c ON c.category_id = p.category_id
    WHERE p.product_id = #{productId}
      AND p.deleted_at IS NULL
  </select>

</mapper>
