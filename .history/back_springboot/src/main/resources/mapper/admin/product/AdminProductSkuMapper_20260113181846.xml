<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enfantTerrible.enfantTerrible.mapper.admin.product.AdminProductSkuMapper">

  <sql id="selectColumns">
    s.sku_id,
    s.product_id,
    s.sku_code,
    s.price,
    s.stock,
    s.status,
    s.created_at
  </sql>

  <sql id="where">
    WHERE s.deleted_at IS NULL

    <if test="req.productId != null">
      AND s.product_id = #{req.productId}
    </if>

    <if test="req.status != null and req.status != ''">
      AND s.status = #{req.status}
    </if>
  </sql>

  <select id="findSkus" resultType="AdminSkuRow">
    SELECT <include refid="selectColumns" />
    FROM et_product_sku s
    <include refid="where" />
    ORDER BY s.sku_id DESC
    LIMIT #{size} OFFSET #{offset}
  </select>

  <select id="countSkus" resultType="int">
    SELECT COUNT(*)
    FROM et_product_sku s
    <include refid="where" />
  </select>

  <select id="findById" resultType="AdminSkuRow">
    SELECT <include refid="selectColumns" />
    FROM et_product_sku s
    WHERE s.sku_id = #{skuId}
      AND s.deleted_at IS NULL
  </select>

  <insert id="insertInternal">
    INSERT INTO et_product_sku (
      product_id,
      sku_code,
      price,
      stock,
      status
    ) VALUES (
      #{productId},
      #{skuCode},
      #{price},
      #{stock},
      #{status}
    )
  </insert>

  <update id="update">
    UPDATE et_product_sku
    SET
      price = #{req.price},
      stock = #{req.stock},
      status = #{req.status}
    WHERE sku_id = #{skuId}
      AND deleted_at IS NULL
  </update>

  <update id="softDelete">
    UPDATE et_product_sku
    SET deleted_at = NOW()
    WHERE sku_id = #{skuId}
      AND deleted_at IS NULL
  </update>

</mapper>
